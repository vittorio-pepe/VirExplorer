# VirExplorer 
## Introduction

VirExplorer is a pipeline used to predict if genomic sequences obtained by a next-generation sequencer, for instance, Illumina, of short length belong to a virus or a human DNA.

It is a binary classifier implemented with a Deep Learning model based on a multilayer Convolutional Neural Network in Keras TensorFlow. The pipeline comprises four scripts that can be run interactively or from the command line that create the databases for the training, encode the data, train the model, and run predictions.

## Environment requirements

VirExplorer has been developed on Ubuntu 20.04 and equipped with an Nvidia RTX-1090Ti GPU, and it requires the following components and packages:

1. Installation of the package bbmap for Ubuntu (sudo apt-get install bbmap)
2. A virtual environment with the latest versions of Python, TensorFlow, biopython, scikit-learn, NumPy, matplotlib, scikit-plot, and seaborn installed.

## Repository Content

This repository contains the following:
1. The four Python scripts comprising the pipeline (dataste_prep.py, encode.py, training.py, VirExlporer.py)
2. 'datasets' folder: contains two examples of files for the reference data needed to train the model on virus and human host genome.
3. 'data_train' folder: an example of the output of the dataset_prep.py and encode.py scripts using the files from the 'datasets' folder.
4. 'data_test' folder: this folder is used to store the file with the sequences to be classified. There are also some sample files that can be used to test the scripts.
5. 'pretrained_model' folder: contains a model trained on a dataset containing about 1,5 million samples of 150bp extracted randomly from the HG38 reference genome and the same number of sequences from a curated human virus dataset obtained from the NCBI data. The model has not been completely optimized yet.
6. 'plots' folder: contains the pre-trained model plots for accuracy, loss, confusion matrix, and auc-roc. It also contains the console output with the metrics: F1 score, Precision, Recall, and Brier Score.

## Previous version of VirExplorer video presentation

VirExplorer was originally developed for my capstone project to classify genome sequences belonging to bacterias and their viruses. Here following there is the link to the youTube video presentation of the project (13 min).

(https://youtu.be/qr-7WfeLFV4 "VirExplorer Video Presentation")


## Scripts Usage

### dataset_prep.py

This script generates the training, validation, and test datasets necessary to train a model. It takes as input a reference dataset for the host (i.e. HG38) or the viruses (from NCBI virus database) in FASTA (.fa) format and randomly extracts the desired number of sequence of desidered legnht.

The script accepts the following arguments:

```python
Usage: dataset_prep.py [options]

Options:
  -h, --help            show this help message and exit
  -i FILENAMEP, --fileName=FILENAMEP
                        Input file name with path
  -p CONTIGTYPE, --contigType=CONTIGTYPE
                        contigType, virus or host
  -l CONTIGLENGTH, --contigLength=CONTIGLENGTH
                        lenght of the samples in bp
  -m MINSEQLEN, --minSeqLen=MINSEQLEN
                        minimum lenght of the DNA
  -n SAMPLESNUMTR, --samplesNumTr=SAMPLESNUMTR
                        number of samples for training
```

The options -i, -p, and -l are mandatory and are, respectively, the reference input file with the path, if it virus or host data, and desired length of the contigs in bp. 
The optional arguments -m and -n indicate the minimum length of the input genome sequences (to avoid bad quality samples) and the number of samples for the training datastet. The default values for -m is 500 and for -n is 1000000.
The script generates also the validation and test datasets having both a prefixed size of 15% of the total.

### encode.py

This script encodes the files generated by the dataset_prep.py script. It needs to be run once for each file to be encoded.

The script accepts the following arguments:

```python
Usage: encode.py [options]

Options:
  -h, --help            show this help message and exit
  -i FILENAMEP, --fileName=FILENAMEP
                        Input name with path
  -l CONTIGLENGTH, --contigLength=CONTIGLENGTH
                        lenght of the samples in bp
  -n SAMPLESNUM, --samplesNum=SAMPLESNUM
                        number of sequences for each split file
```

The options -i and -l are mandatory and are, respectively, the input file to be encoded with path and length of the contigs in bp contained in the input file.
The optional argument -n indicate the number of sequences for each split file containing the encoded sequence. This option is used to limit the RAM memory usage to 32G and has a default value set to 500000. It can be increased if the script is run on a server with more RAM available. 

### training.py

This script trains the model and generate the metrics (confusion matrix, AUC-ROC, F1 score, Brier Score) and plots of the trained model. 
The script accepts the following arguments:

```python
Usage: training.py [options]

Options:
  -h, --help            show this help message and exit
  -l CONTIGLENGTH, --len=CONTIGLENGTH
                        contig Length
  -i INDIR, --indir=INDIR
                        input directory for training, validation and test data
  -o OUTDIR, --outdir=OUTDIR
                        output directory for the models
  -e EPOCHS, --epochs=EPOCHS
                        number of epochs
```

The options -i and -l are mandatory and are, respectively, the input directory of the file(s) to be predicted and length of the contigs in bp contained in the input file.
The optional arguments -o and -e indicate the directory containing the trained model, and the number of epochs for the training (default 50). 
The training script has early stopping on validation loss.

### VirExplorer.py

This script generates the predictions using the trained model. It takes as input a file in fasta format with the genome sequences to be predicted and generates a CSV file containing the name of samples, its legnth, the score between 0 (host) and 1 (virus), and the p-value.

```python
Usage: VirExplorer.py [options]

Options:
  -h, --help            show this help message and exit
  -i FILENAMEP, --in=FILENAMEP
                        input file in fasta format with path
  -l CONTIGLENGTH, --len=CONTIGLENGTH
                        contig Length
  -n SAMPLESNUM, --samplesNum=SAMPLESNUM
                        number of sequences for each split file
  -m MODDIR, --mod=MODDIR
                        model directory (default ./data_train_models)
  -o OUTDIR, --out=OUTDIR
                        output directory (default ./output
  -c CUTOFFLEN, --ctf=CUTOFFLEN
                        predict only for sequence >= l bp (default 80)
```

The options -i, and -l are mandatory and are the reference input file with path and the length of the contigs contained in the file. 
The optional argument -n indicates the number of sequence for each split file to be predicted. This option is used to limit the RAM memory usage to 16G and has a default value of 500000. It can be increased if the script is run on a server with more RAM available. 
The optional arguments -m, -o , and -c are the directory containing the trained model, the output directory for the CSV file generated, and the minimum length of the sequences to be predicted (default 80).
